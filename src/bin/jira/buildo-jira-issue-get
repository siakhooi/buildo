#!/bin/bash

usage() {
  echo "Usage: $(basename "$0") [-h] [-f attachment_filename] jira# [jqquery]"
  echo "Example: $(basename "$0") XXXX-12345"
  echo "Example: $(basename "$0") XXXX-12345 '.fields.status.name'"
  echo "Example: $(basename "$0") XXXX-12345 '.fields.summary'"
  echo "Example: $(basename "$0") -f attachment_filename XXXX-12345 '.id'"
}
while getopts "hf:" arg; do
  case $arg in
  h)
    usage
    exit 0
    ;;
  f)
    attachment_filename=$OPTARG
    ;;
  *)
    usage
    exit 1
    ;;
  esac
done
shift $((OPTIND - 1))
if [[ $# -ne 1 ]] && [[ $# -ne 2 ]]; then
  usage
  exit 0
fi

readonly JIRA_NUMBER=$1
readonly jq_query=$2

if [[ $# -eq 1 ]]; then

  if [[ -n "$attachment_filename" ]]; then
    buildo-jira-curl "issue/$JIRA_NUMBER" | jq -r '.fields.attachment[]|select(.filename == "'"$attachment_filename"'")'
  else
    buildo-jira-curl "issue/$JIRA_NUMBER"
  fi

elif [[ $# -eq 2 ]]; then

  if [[ -n "$attachment_filename" ]]; then
    buildo-jira-curl "issue/$JIRA_NUMBER" | jq -r '.fields.attachment[]|select(.filename == "'"$attachment_filename"'")' | jq -r "$jq_query"
  else
    buildo-jira-curl "issue/$JIRA_NUMBER" | jq -r "$jq_query"
  fi

fi
