#!/bin/bash

readonly message_directory=$HOME/.buildo-message
readonly message_time_file=$HOME/.buildo-message-time

usage() {
  echo "Usage: $(basename "$0") [-h] [OPTION]"
  echo "Options:"
  echo "  -a TITLE MESSAGE    Add a message item with title and message"
  echo "  -s                  Show new messages"
  echo "  -p                  print file name, for -s option"
  echo "  -h, --help          Show this help message"
}
action=
print_file=false
while getopts "hsap" arg; do
  case $arg in
  h)
    usage
    exit 0
    ;;
  s)
    if [[ -n $action ]] && [[ $action != "show" ]]; then
      echo.error "Only one action can be specified"
      usage
      exit 1
    fi
    action=show
    ;;
  a)
    if [[ -n $action ]] && [[ $action != "add" ]]; then
      echo.error "Only one action can be specified"
      usage
      exit 1
    fi
    action=add
    ;;
  p)
    print_file=true
    ;;
  *)
    usage
    exit 1
    ;;
  esac
done
shift $((OPTIND - 1))
if [[ -z $action ]] ; then
  usage
  exit 0
fi
if [[ $action == 'show' ]] && [[ $# -ne 0 ]] ; then
  usage
  exit 0
fi
if [[ $action == 'add' ]] && [[ $# -ne 2 ]]; then
  usage
  exit 1
fi


add_message() {
  local title="$1"
  local message="$2"

  if [[ -z "$title" ]]; then
    echo.error "Title is required for adding message"
    usage
    exit 1
  fi

  mkdir -p "$message_directory"
  local message_file
  message_file="$message_directory/$(y2n)-$title.txt"

  if [[ -n "$message" ]]; then
    echo "$message" > "$message_file"
  else
    cat > "$message_file"
  fi
}

show_messages() {
  if [[ ! -f "$message_time_file" ]]; then
    touch -d '1970-01-01' "$message_time_file"
  fi

  local shown_any=false

  if [[ -d "$message_directory" ]]; then
    for message_file in "$message_directory"/*; do
      if [[ -f "$message_file" ]]; then
        if [[ $message_file -nt $message_time_file ]]; then
          if ! $shown_any; then
            echo.cyan "New messages available:"
            shown_any=true
          fi
          if [[ $print_file == true ]]; then
            echo.green "$(basename "$message_file"):"
          fi
          cat.grey < "$message_file"
        fi
      fi
    done

    if $shown_any; then
      echo
      touch "$message_time_file"
    fi
  fi
}

if [[ $action == "add" ]]; then
  add_message "$1" "$2"
  exit 0
fi
if [[ $action == "show" ]]; then
  show_messages
  exit 0
fi
