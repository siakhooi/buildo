#!/bin/bash

usage() {
	echo "Usage: $(basename "$0") [-h] [-s] [-A] [-D] [-V]"
	echo " -h   display this help message"
	echo " -s   remove stopped containers"
	echo " -A   remove all images"
	echo " -D   remove dangling images"
	echo " -V   stop and remove all devcontainers containers"
}
action=
while getopts "hsADV" arg; do
	case $arg in
	h)
		usage
		exit 0
		;;
	s)
		if [[ -n $action ]] && [[ $action != 'stop_container' ]]; then
			echo.error "-s is the only option"
			usage
			exit 1
		fi
		action=stop_container
		;;
	A)
		if [[ -n $action ]] && [[ $action != 'all_images' ]]; then
			echo.error "-A is the only option"
			usage
			exit 1
		fi
		action=all_images
		;;
	D)
		if [[ -n $action ]] && [[ $action != 'dangling_images' ]]; then
			echo.error "-D is the only option"
			usage
			exit 1
		fi
		action=dangling_images
		;;
	V)
		if [[ -n $action ]] && [[ $action != 'remove_devcontainers' ]]; then
			echo.error "-V is the only option"
			usage
			exit 1
		fi
		action=remove_devcontainers
		;;
	*)
		usage
		exit 1
		;;
	esac
done
shift $((OPTIND - 1))
if [[ $# -ne 0 ]]; then
	usage
	exit 0
fi
if [[ -z $action ]]; then
	usage
	exit
fi

if [[ $action == 'stop_container' ]]; then
	(
		set -x
		docker container prune -f
	)
elif [[ $action == 'all_images' ]]; then
	(
		set -x
		docker images -a -q | xargs -I {} docker image rm -f {}
	)
elif [[ $action == 'dangling_images' ]]; then
	(
		set -x
		docker image prune -f
	)

elif [[ $action == 'remove_devcontainers' ]]; then
	(
		set -x
		docker ps -q -a --filter 'label=devcontainer.config_file' | xargs -r docker rm -f
	)

fi
