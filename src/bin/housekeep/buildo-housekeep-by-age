#!/usr/bin/env bash

recursive=false
dry_run=false
age_in_days=30
min_to_keep=1
use_regex=false
file_type=f

usage() {
  echo "Usage: $(basename "$0") [-h] [-r] [-d] [-a days] [-D] [-e] [-m minimum_to_keep] directory [name_filter]"
  echo " -r            recursive"
  echo " -a   <days>   age in days, default: 30"
  echo " -m   <count>  minimum files to keep, default: 1"
  echo " -e            name_filter is regex"
  echo " -D            find directory instead of file"
  echo " -d            dry run"
}
while getopts "hrdDea:m:" arg; do
  case $arg in
    h)
      usage
      exit 0
    ;;
    m)
      min_to_keep="$OPTARG"
    ;;
    d)
      dry_run=true
    ;;
    r)
      recursive=true
      ;;
    e)
      use_regex=true
      ;;
    D)
      file_type=d
    ;;
    a)
      age_in_days="$OPTARG"
    ;;
    *)
      usage
      exit 1
    ;;
  esac
done
shift $((OPTIND - 1))
if [[ $# -lt 1 || $# -gt 2 ]]; then
  usage
  exit 0
fi

TARGET_DIR=$1
name_filter=$2

set -euo pipefail

# Validate target directory
if [[ ! -d "$TARGET_DIR" ]]; then
  echo.error "Error: $TARGET_DIR is not a directory."
  exit 1
fi

target_directory=$(realpath "$TARGET_DIR")

find_options=("$target_directory")

find_options+=(-mindepth 1)
if [[ "$recursive" == "false" ]]; then
  find_options+=(-maxdepth 1)
fi
find_options+=(-type "$file_type")
if [[ -n "$name_filter" ]]; then
  if [[ "$use_regex" == "true" ]]; then
    find_options+=(-regextype posix-extended -regex "$target_directory/$name_filter")
  else
    find_options+=(-name "$name_filter")
  fi
fi

# Collect all files sorted by modification time (newest first)
mapfile -t FILES < <(find "${find_options[@]}" -printf "%T@ %p\n" | sort -nr | awk '{print $2}')

TOTAL_FILES=${#FILES[@]}
if (( TOTAL_FILES == 0 )); then
  echo "No files found in $TARGET_DIR"
  exit 0
fi

# Files to protect (minimum kept)
PROTECT_COUNT=$(( min_to_keep < TOTAL_FILES ? min_to_keep : TOTAL_FILES ))
PROTECT_FILES=("${FILES[@]:0:$PROTECT_COUNT}")

# Turn protected files into a set
declare -A PROTECTED
for f in "${PROTECT_FILES[@]}"; do
  # echo "protect $f"
  PROTECTED["$f"]=1
done

# process old files except protected ones
NOW=$(date +%s)
for f in "${FILES[@]}"; do
  # Check age
  MTIME=$(stat -c %Y "$f")
  AGE_DAYS=$(( (NOW - MTIME) / 86400 ))

  #  Skip protected
  if [[ -n "${PROTECTED[$f]:-}" ]]; then
    echo.magenta "keep min   [age: $AGE_DAYS]: $f"
    continue
  fi

  if (( AGE_DAYS > age_in_days )); then
    echo.grey "delete old [age: $AGE_DAYS]: $f"
    if [[ "$dry_run" != "true" ]]; then
      if [[ "$file_type" == "d" ]]; then
        # remove directory and its contents
        (
          set -x
          rm -rf -- "$f"
        )
      else
        (
          set -x
          rm -f -- "$f"
        )
      fi
    fi
  else
    echo.magenta "keep young [age: $AGE_DAYS]: $f"
  fi
done
